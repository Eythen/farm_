<html lang="zh-cmn-Hans">

	<head>
		<!-- 声明文档使用的字符编码 -->
		<meta charset='utf-8'>
		<!-- 优先使用 IE 最新版本和 Chrome -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<!-- 页面描述 -->
		<meta name="description" content="不超过150个字符" />
		<!-- 页面关键词 -->
		<meta name="keywords" content="" />
		<!-- 网页作者 -->
		<meta name="author" content="guo,652730268@qq.com" />
		<!-- 搜索引擎抓取 -->
		<meta name="robots" content="index,follow" />
		<!-- 为移动设备添加 viewport -->
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=3,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" />
		<!-- `width=device-width` 会导致 iPhone 5 添加到主屏后以 WebApp 全屏模式打开页面时出现黑边 http://bigc.at/ios-webapp-viewport-meta.orz -->

		<!-- iOS 设备 begin -->
		<meta name="apple-mobile-web-app-title" content="标题">
		<!-- 添加到主屏后的标题（iOS 6 新增） -->
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<!-- 是否启用 WebApp 全屏模式，删除苹果默认的工具栏和菜单栏 -->

		<!--meta name="apple-itunes-app" content="app-id=myAppStoreID, affiliate-data=myAffiliateData, app-argument=myURL" -->
		<!-- 添加智能 App 广告条 Smart App Banner（iOS 6+ Safari） -->
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<!-- 设置苹果工具栏颜色 -->
		<meta name="format-detection" content="telphone=no, email=no" />
		<!-- 忽略页面中的数字识别为电话，忽略email识别 -->

		<!-- 启用360浏览器的极速模式(webkit) -->
		<meta name="renderer" content="webkit">
		<!-- 避免IE使用兼容模式 -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!-- 不让百度转码 -->
		<meta http-equiv="Cache-Control" content="no-siteapp" />
		<!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
		<meta name="HandheldFriendly" content="true">
		<!-- 微软的老式浏览器 -->
		<meta name="MobileOptimized" content="320">
		<!-- uc强制竖屏 -->
		<meta name="screen-orientation" content="portrait">
		<!-- QQ强制竖屏 -->
		<meta name="x5-orientation" content="portrait">
		<!-- UC强制全屏 -->
		<meta name="full-screen" content="yes">
		<!-- QQ强制全屏 -->
		<meta name="x5-fullscreen" content="true">
		<!-- UC应用模式 -->
		<meta name="browsermode" content="application">
		<!-- QQ应用模式 -->
		<meta name="x5-page-mode" content="app">
		<!-- windows phone 点击无高光 -->
		<meta name="msapplication-tap-highlight" content="no">
		<!-- iOS 图标 begin -->
		<link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-57x57-precomposed.png" />
		<!-- iPhone 和 iTouch，默认 57x57 像素，必须有 -->
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114-precomposed.png" />
		<!-- Retina iPhone 和 Retina iTouch，114x114 像素，可以没有，但推荐有 -->
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144-precomposed.png" />
		<!-- Retina iPad，144x144 像素，可以没有，但推荐有 -->
		<!-- iOS 图标 end -->

		<!-- iOS 启动画面 begin -->
		<link rel="apple-touch-startup-image" sizes="768x1004" href="__PUBLIC__/skin/agent/img/App-ios-logo-152x152.png" />

		<link rel="apple-touch-startup-image" href="__PUBLIC__/skin/agent/img/App-ios-logo-152x152.png" />
		<!-- iPhone/iPod Touch 竖屏 320x480 (标准分辨率) -->
		<link rel="apple-touch-startup-image" sizes="640x960" href="__PUBLIC__/skin/agent/img/App-ios-logo-152x152.png" />
		<!-- iPhone/iPod Touch 竖屏 640x960 (Retina) -->
		<link rel="apple-touch-startup-image" sizes="640x1136" href="__PUBLIC__/skin/agent/img/App-ios-logo-152x152.png" />
		<!-- iPhone 5/iPod Touch 5 竖屏 640x1136 (Retina) -->
		<!-- iOS 启动画面 end -->

		<!-- iOS 设备 end -->
		<meta name="msapplication-TileColor" content="#000" />
		<!-- Windows 8 磁贴颜色 -->
		<meta name="msapplication-TileImage" content="icon.png" />
		<!-- Windows 8 磁贴图标 -->

		<link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" />
		<!-- 添加 RSS 订阅 -->
		<link rel="shortcut icon" type="image/ico" href="/favicon.ico" />
		<!-- 添加 favicon icon -->

		<title>提货单</title>

		<link href="__PUBLIC__/skin/agent/css/weui.min.css" rel="stylesheet">
		<link href="__PUBLIC__/skin/agent/css/jquery-weui.css" rel="stylesheet">
		<link href="__PUBLIC__/skin/agent/font/iconfont.css" rel="stylesheet">
		<link href="__PUBLIC__/skin/agent/css/style.css" rel="stylesheet">
		<link href="__PUBLIC__/skin/agent/css/cart.css" rel="stylesheet">
		<style>
			.weui-cell {
				padding: 25px 30px;
				font-size: 28px;
			}
			
			.weui-label {
				width: 130px;
			}
			
			.weui-cell:before {
				border-top: 2px solid #d9d9d9;
			}
			
			.weui-input {
				font-size: 30px;
				height: 1.61176471em;
				line-height: 1.61176471;
			}
			
			.toolbar {
				position: relative;
				width: 100%;
				font-size: 30px;
				line-height: 100px;
				color: #3d4145;
				background: #f7f7f8;
				padding: 0 30px;
			}
			
			.toolbar .toolbar-inner {
				height: 100px;
			}
			
			.toolbar .picker-button {
				height: 100px;
				line-height: 100px;
				color: #ffa204;
				padding: 0 30px;
			}
			
			.toolbar .title {
				font-size: 30px;
				line-height: 100px;
				color: #3d4145;
				text-align: left;
			}
			
			.weui-picker-modal {
				height: 600px;
				background: #cfd5da;
			}
			
			.weui-picker-modal .picker-modal-inner {
				position: relative;
				height: 500px;
			}
			
			.weui-picker-modal .picker-center-highlight {
				height: 100px;
				box-sizing: border-box;
				position: absolute;
				left: 0;
				width: 100%;
				top: 50%;
				margin-top: -50px;
				pointer-events: none;
			}
			
			.weui-picker-modal .picker-item {
				height: 100px;
				line-height: 100px;
				padding: 0 20px;
				white-space: nowrap;
				position: relative;
				overflow: hidden;
				text-overflow: ellipsis;
				color: #9b9b9b;
				left: 0;
				top: 0;
				width: 100%;
				box-sizing: border-box;
				-webkit-transition: 300ms;
				transition: 300ms;
			}
			
			.weui-picker-modal .picker-center-highlight:before {
				height: 2px;
				background-color: #a8abb0;
			}
			
			.weui-picker-modal .picker-center-highlight:after {
				height: 2px;
				background-color: #a8abb0;
			}
		</style>

		<!-- 自适应处理页面js -->
		<script src="__PUBLIC__/skin/agent/js/flexible.js"></script>

	</head>

	<body ontouchstart>

		<div class="stage">

			<header class="header">
				<a class="icon-back" href="javascript:history.go(-1);"></a>
				<div class="header-title">提货单</div>
			</header>

			<div class="picktop">

				<div class="weui-cells top">
					<div class="weui-cell">
						<div class="weui-cell__hd"><label class="weui-label">收   件   人</label></div>
						<div class="weui-cell__bd">
							<input class="weui-input" id="username" type="text" placeholder="">
						</div>
					</div>
					<div class="weui-cell">
						<div class="weui-cell__hd"><label class="weui-label">联系电话</label></div>
						<div class="weui-cell__bd">
							<input class="weui-input" id="Mobile" type="number" pattern="[0-9]*" placeholder="" required>
						</div>
					</div>
					<div class="weui-cell">
						<div class="weui-cell__hd"><label class="weui-label">所在地区</label></div>
						<div class="weui-cell__bd">
							<input class="weui-input" id="end" type="text" placeholder="" required>
						</div>
					</div>
					<div class="weui-cell">
						<div class="weui-cell__hd"><label class="weui-label">街道门号</label></div>
						<div class="weui-cell__bd">
							<input class="weui-input" id="street" type="text" placeholder="">
							<input id="ids" type="hidden" value="">
						</div>
					</div>
				</div>

				<div class="cart">
					<div class="list">子订单号：{$order_id}</div>
					<ul ind="0">
						{volist name="goods" id="vo"}
						<li data-id="{$vo.goods_id}" data-price="{$vo.shop_price}" data-selected='{eq name="key" value="0"}1{else/}0{/eq}'>
							<div class="specialty-box">
						    	<div class="list-bd">
						    		<div class="orderimg">
						    			<img src="{$vo.original_img}"/>
						    		</div>
						    		<div class="text">
						    			<h1>{$vo.goods_name}</h1>
						    			<p class="textsp">{$vo.goods_remark}</p>
						    			<div class="spbox">
						    				<span class="red">￥{$vo.shop_price}</span>	
                                            <span class="text2">
						    					<input type="button" value="-" class="btn1" />
						    					<span class="number">{eq name="key" value="0"}1{else/}0{/eq}</span>
											    <input type="button" value="+" class="btn2" />
											</span>
						    			</div>
						    		</div>
						    	</div>
						   </div>
						</li>

						
						{/volist}
						
					</ul>
					<p class="total">一共<number class="number"></number>件商品</p>
				</div>

				<!--结算-->
				<ul class="bottom-nav">
					<li>
						<p class="through"></p>
						<p class="huise">原价</p>
					</li>
					<li>
						<p>{$discount}折</p>
						<p class="huise">代理折价</p>
					</li>
					<li>
						<p><small class="red">￥</small><span class="red merw"></span></p>
						<p class="huise">合计金额</p>
					</li>
				</ul>
				<div class="bottom-nav2">
					<div class="nav-left">余额：<small>￥</small><span>{$spare_amount}</span></div>
					<div class="nav-right">
						<div class="nopay" style="position: absolute; width: 100%;height:100%; filter:alpha(opacity=5); -moz-opacity:0.5; opacity:0.5; background-color:#000;"></div> <button class="sett" id="pay">结  算</button>
					</div>
				</div>
			</div>
			
			
		</div>
		
		
		<!--弹框-->
		<div class="text1">
			<div class="puop">
				<h6>请输入数量</h6>
				<input type="number" class="shuli" pattern="[0-9]*" />
				<input type="button" class="btn" value="确定" />
			</div>
		</div>
		
		<div class="media">该页面不支持电脑端浏览，请用手机浏览。</div>
	</body>

	<!-- js -->
	<script src="__PUBLIC__/skin/agent/js/jquery-2.1.4.js"></script>
	<script src="__PUBLIC__/skin/agent/js/fastclick.js"></script>
	<script>
		$(function() {
			//消除延迟
			FastClick.attach(document.body);
		});
	</script>
	<script src="__PUBLIC__/skin/agent/js/jquery-weui.js"></script>
	<script src="__PUBLIC__/skin/agent/js/city-picker.js"></script>
<!-- 	<script src="__PUBLIC__/skin/agent/js/catr.js"></script> -->
	<script>
		$(function() {

			// 地址输入判断
			$('#pay').click(function(event) {
				var username = $('#username').val();
				partten = /^[\u4E00-\u9FA5A-Za-z]+$/;
				Mobile = $('#Mobile').val();
				reg = /^1\d{10}$/;
				end = $('#end').val();
				street = $('#street').val();
				tolerate = $('#tolerate').val();//请选择默认地址
				ids = $('#ids').val();
				order_id = {$order_id};
				if(username == '') {
					$('#username').focus();
					$.toast('输入姓名', 'text');
					return false;
				} else if(!partten.test(username)) {
					$.toast('输入姓名不正确?', 'text');
					return false;
				} else if(Mobile == '') {
					$('#Mobile').focus();
					$.toast('输入11位数手机号', 'text');
					return false;
				} else if(!reg.test(Mobile)) {
					$.toast('输入手机号码不正确?', 'text');
					return false;
				} else if(end == '') {
					$('#end').focus();
					$.toast('输入所在地区', 'text');
					return false;
				} else if(street == '') {
					$('#street').focus();
					$.toast('输入详情地址', 'text');
					return false;
				} else if(ids == ''){
					$.toast('请选取商品', 'text');
					return false;
				
				} else {
					//$.toast("提交订单成功", "text");
					$.showLoading('正在提交...');
					
					$.ajax({
	                    url: "{:url('Order/pick')}",
	                    type: 'POST',
	                    dataType: 'json',
	                    data: {ids:ids, username:username, end:end, street:street, mobile:Mobile, order_id:order_id},
	                    success: function(data){
							$.hideLoading();
	                        if( data.code ){
								window.location.href = data.msg;
	                            return false;
	                        }else{
	                        	$.toast(data.msg, "text");
	                            return false;
	                        }
	                    }
	                });
				}
			});

			// 地区
			$("#end").cityPicker({
				title: "选择地区"
			});

		});
	</script>
	<script type="text/javascript">
/*计算总钱数*/
function total() {
	var goods_num = 0, //商品数量
		total_price = 0, //总价 
		pay_price = 0, //折后价
		discount = '{$discount}'; //等级折扣
		ids = new Array(); //选择商品

		setTimeout(function() {  //延迟些读取，使数据能正常加载
			$('.cart li').each(function(){
				var selected = $(this).attr('data-selected');
					console.log('selected:' + selected)
				/*	return;*/
				if(selected>0){
					goods_num += parseInt(selected);
					total_price += $(this).data('price') * selected;
					var str = $(this).data('id') + "-" + selected;
					ids.push(str);

				}
			});
			ids = ids.join(',');
			pay_price = total_price * discount / 10;
			$(".bottom-nav .merw").html(pay_price.toFixed(2));
			$(".bottom-nav .through").html("￥" + total_price.toFixed(2));
			$(".total .number").html(goods_num);
			$('#ids').val(ids);
			var spare_amount = $(".bottom-nav2 .nav-left").find('span').text(),
				spare = spare_amount - pay_price;
				console.log(spare);
			if(spare<0){
				$.toast('选取商品超过了订单余额，请确保小于或等于，才能提货！', 'text');
				$(".nopay").show();
			}
			else{
				$(".nopay").hide();
			}

		}, 100);
	/*setTimeout(function() {
		var S = 0;
		$.each($('.total'), function() {
			var $ul_total = $(this).prev('ul');
			var s = 0;
			var n1 = 0;
			$.each($(this).prev('ul').find(".number"), function(i) {
				if($ul_total.eq(i)) {
					s = s + parseInt($(this).html()) * parseInt($(this).parent().prev().html().replace("￥", ""));
					n1 = n1 + parseInt($(this).html());
				}
			});
			$(this).children(".red").html("￥" + s.toFixed(2));
			$(this).children("number").html(n1);
			S = S + s;
		});
		$(".bottom-nav .merw").html(S.toFixed(2));
	}, 100)*/
}

$(function() {
	total();

	/*加*/
	$('.btn2').click(function() {
		var c_num = parseInt($(this).prev('.number').html()) + 1;
		$(this).prev('.number').html(c_num);
		console.log(c_num);
		$(this).closest('li').attr('data-selected', c_num);
		total();
	})

	/*减*/
	$('.btn1').click(function() {
		if($(this).next('.number').html() == 0){
			$(this).next('.number').html(0);
			$(this).closest('li').attr('data-selected', 0);
		}else{
			var c_num = parseInt($(this).next('.number').html()) - 1;
			$(this).next('.number').html(c_num);
			$(this).closest('li').attr('data-selected', c_num);
		}
		total();
	})
	/*点击减一*/
	$(".number").click(function() {
		$('.text1').css({
			"display": "flex",
			"-webkit-display": "flex"
		}).attr({
			'ind': $(this).parents('li').index(),
			"ind_1": $(this).parents("ul").attr("ind")
		});
		$('.shuli').val($(this).html());
	})
	
	$('.btn').click(function() {
		var shuli = $('.shuli').val();
		    reg = /^[1-9]\d*$/;
		if(shuli == '') {
			$('.shuli').focus();
			$.toast('请输入数量！', 'text');
			return false;
		} else if(!reg.test(shuli)) {
			$.toast('请输入正整数?', 'text');
			return false;
		} else if($('.shuli').val() > 1000) {
			$.toast('超出库存了！', 'text');
			return false;
		}
		$("ul").eq($('.text1').attr('ind_1')).find(".number").eq($('.text1').attr('ind')).html($('.shuli').val());
		$("ul").eq($('.text1').attr('ind_1')).find(".number").eq($('.text1').attr('ind')).closest('li').attr('data-selected',$('.shuli').val());
		$('.text1').css({
			"display": "none",
			"-webkit-display": "none"
		});
		total();
	});
	
})
	</script>

</html>